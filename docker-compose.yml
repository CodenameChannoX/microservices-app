version: '3.8'

services:
  # Development container
  devcontainer:
    image: mcr.microsoft.com/devcontainers/base:ubuntu-22.04
    volumes:
      - ..:/workspace:cached
    command: sleep infinity
    networks:
      - microservices-net

  # PostgreSQL Database for User Service
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: userdb
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - microservices-net

  # MongoDB Database for Product Service
  mongodb:
    image: mongo:6
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - microservices-net

  # User Service (PostgreSQL)
  user-service:
    build: ./user-service
    ports:
      - "3001:3001"
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: userdb
      DB_USER: admin
      DB_PASSWORD: admin123
      JWT_SECRET: your-super-secret-jwt-key-12345
    depends_on:
      - postgres
    networks:
      - microservices-net

  # Product Service (MongoDB)
  product-service:
    build: ./product-service
    ports:
      - "3002:3002"
    environment:
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017
      MONGODB_DB: productdb
    depends_on:
      - mongodb
    networks:
      - microservices-net

  # API Gateway
  api-gateway:
    build: ./api-gateway
    ports:
      - "3000:3000"
    environment:
      USER_SERVICE_URL: http://user-service:3001
      PRODUCT_SERVICE_URL: http://product-service:3002
      JWT_SECRET: your-super-secret-jwt-key-12345
    depends_on:
      - user-service
      - product-service
    networks:
      - microservices-net

  # Frontend (Vue.js)
  frontend:
    build: ./frontend
    ports:
      - "8080:8080"
    environment:
      VITE_API_URL: http://localhost:3000
    depends_on:
      - api-gateway
    networks:
      - microservices-net

networks:
  microservices-net:
    driver: bridge

volumes:
  postgres_data:
  mongodb_data:
